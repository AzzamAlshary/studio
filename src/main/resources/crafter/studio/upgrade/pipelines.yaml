# Crafter Studio Upgrade Configuration

pipelines:

  # Pipeline to upgrade system components (database, global repo, ...)
  system:
    - currentVersion: 3.0.0
      nextVersion: 3.0.1
      operations:
        - type: dbScriptUpgrader
          filename: upgrade-3.0.0-to-3.0.1.sql
          updateIntegrity: false # Needs to be set to false in all version previous to 3.0.17

    - currentVersion: 3.0.1
      nextVersion: 3.0.2
      operations:
        - type: dbScriptUpgrader
          filename: upgrade-3.0.1-to-3.0.2.sql
          updateIntegrity: false

    - currentVersion: 3.0.2
      nextVersion: 3.0.2.1
      operations:
        - type: dbScriptUpgrader
          filename: upgrade-3.0.2-to-3.0.2.1.sql
          updateIntegrity: false

    - currentVersion: 3.0.2.1
      nextVersion: 3.0.10
      operations:
        - type: dbScriptUpgrader
          filename: upgrade-3.0.2.1-to-3.0.10.sql
          updateIntegrity: false

    - currentVersion: 3.0.10
      nextVersion: 3.0.11
      operations:
        - type: dbScriptUpgrader
          filename: upgrade-3.0.10-to-3.0.11.sql
          updateIntegrity: false

    - currentVersion: 3.0.11
      nextVersion: 3.0.11.1
      operations:
        - type: dbScriptUpgrader
          filename: upgrade-3.0.11-to-3.0.11.1.sql
          updateIntegrity: false

    - currentVersion: 3.0.11.1
      nextVersion: 3.0.11.2
      operations:
        - type: dbScriptUpgrader
          filename: upgrade-3.0.11.1-to-3.0.11.2.sql
          updateIntegrity: false

    - currentVersion: 3.0.11.2
      nextVersion: 3.0.11.3
      operations:
        - type: dbScriptUpgrader
          filename: upgrade-3.0.11.2-to-3.0.11.3.sql
          updateIntegrity: false

    - currentVersion: 3.0.11.3
      nextVersion: 3.0.15
      operations:
      - type: dbScriptUpgrader
        filename: upgrade-3.0.11.3-to-3.0.15.sql
        updateIntegrity: false

    - currentVersion: 3.0.15
      nextVersion: 3.0.15.1
      operations:
        - type: dbScriptUpgrader
          filename: upgrade-3.0.15-to-3.0.15.1.sql
          updateIntegrity: false

    - currentVersion: 3.0.15.1
      nextVersion: 3.1.0
      operations:
      - type: dbScriptUpgrader
        filename: upgrade-3.0.15.1-to-3.1.0.sql

    - currentVersion: 3.0.17
      nextVersion: 3.1.0
      operations:
      - type: dbScriptUpgrader
        filename: upgrade-3.0.17-to-3.1.0.sql

    - currentVersion: 3.1.0
      nextVersion: 3.1.0.1
      operations:
        - type: dbScriptUpgrader
          filename: upgrade-3.1.0-to-3.1.0.1.sql
        - type: globalRepoUpgrader
          files:
            - src: crafter/studio/upgrade/3.1.0.1/repo-bootstrap/global/configuration/global-menu-config.xml
              dest: configuration/global-menu-config.xml
            - src: crafter/studio/upgrade/3.1.0.1/repo-bootstrap/global/configuration/global-permission-mappings-config.xml
              dest: configuration/global-permission-mappings-config.xml
            - src: crafter/studio/upgrade/3.1.0.1/repo-bootstrap/global/configuration/global-role-mappings-config.xml
              dest: configuration/global-role-mappings-config.xml

    - currentVersion: 3.1.0.1
      nextVersion: 3.1.0.2
      operations:
        - type: dbScriptUpgrader
          filename: upgrade-3.1.0.1-to-3.1.0.2.sql

    - currentVersion: 3.1.0.2
      nextVersion: 3.1.0.3
      operations:
        - type: dbScriptUpgrader
          filename: upgrade-3.1.0.2-to-3.1.0.3.sql

    - currentVersion: 3.1.0.3
      nextVersion: 3.1.0.4
      operations:
        - type: dbScriptUpgrader
          filename: upgrade-3.1.0.3-to-3.1.0.4.sql
          updateIntegrity: false # Because the script only changes content

    - currentVersion: 3.1.0.4
      nextVersion: 3.1.0.5
      operations:
      - type: dbScriptUpgrader
        filename: upgrade-3.1.0.4-to-3.1.0.5.sql
        updateIntegrity: true

    - currentVersion: 3.1.0.5
      nextVersion: 3.1.0.6
      operations:
      - type: dbScriptUpgrader
        filename: upgrade-3.1.0.5-to-3.1.0.6.sql
        updateIntegrity: true

    - currentVersion: 3.1.0.6
      nextVersion: 3.1.0.7
      operations:
      - type: dbScriptUpgrader
        filename: upgrade-3.1.0.6-to-3.1.0.7.sql
        updateIntegrity: true

    - currentVersion: 3.1.0.7
      nextVersion: 3.1.0.8
      operations:
      - type: dbScriptUpgrader
        filename: upgrade-3.1.0.7-to-3.1.0.8.sql
        updateIntegrity: true
      - type: xsltFileUpgrader
        path: /configuration/global-menu-config.xml
        template: crafter/studio/upgrade/3.1.0.8/global-menu-config-2.xslt
      - type: xsltFileUpgrader
        path: /configuration/global-permission-mappings-config.xml
        template: crafter/studio/upgrade/3.1.0.8/global-permission-mappings-config-2.xslt

    - currentVersion: 3.1.0.8
      nextVersion: 3.1.0.9
      operations:
      - type: dbScriptUpgrader
        filename: upgrade-3.1.0.8-to-3.1.0.9.sql
        updateIntegrity: true

    - currentVersion: 3.1.0.9
      nextVersion: 3.1.0.10
      operations:
        - type: dbScriptUpgrader
          filename: upgrade-3.1.0.9-to-3.1.0.10.sql
          updateIntegrity: true

    - currentVersion: 3.1.0.10
      nextVersion: 3.1.0.11
      operations:
        - type: dbScriptUpgrader
          filename: upgrade-3.1.0.10-to-3.1.0.11.sql
          updateIntegrity: true

    - currentVersion: 3.1.0.11
      nextVersion: 3.1.0.12
      operations:
        - type: dbScriptUpgrader
          filename: upgrade-3.1.0.11-to-3.1.0.12.sql
          updateIntegrity: true

    - currentVersion: 3.1.0.12
      nextVersion: 3.1.0.13
      operations:
        - type: dbScriptUpgrader
          filename: upgrade-3.1.0.12-to-3.1.0.13.sql
          updateIntegrity: true

    - currentVersion: 3.1.0.13
      nextVersion: 3.1.0.14
      operations:
        - type: dbScriptUpgrader
          filename: upgrade-3.1.0.13-to-3.1.0.14.sql
          updateIntegrity: true
        - type: xsltFileUpgrader
          path: /configuration/global-permission-mappings-config.xml
          template: crafter/studio/upgrade/3.1.0.14/global-permission-mappings-config-3.xslt

    - currentVersion: 3.1.0.14
      nextVersion: 3.1.0.15
      operations:
        - type: dbScriptUpgrader
          filename: upgrade-3.1.0.14-to-3.1.0.15.sql
          updateIntegrity: true
        - type: globalRepoUpgrader
          files:
            - src: crafter/studio/upgrade/3.1.0.15/repo-bootstrap/global/blueprints/empty/craftercms-plugin.yaml
              dest: blueprints/empty/craftercms-plugin.yaml
            - src: crafter/studio/upgrade/3.1.0.15/repo-bootstrap/global/blueprints/headless_blog/craftercms-plugin.yaml
              dest: blueprints/headless_blog/craftercms-plugin.yaml
            - src: crafter/studio/upgrade/3.1.0.15/repo-bootstrap/global/blueprints/headless_store/craftercms-plugin.yaml
              dest: blueprints/headless_store/craftercms-plugin.yaml
            - src: crafter/studio/upgrade/3.1.0.15/repo-bootstrap/global/blueprints/website_editorial/craftercms-plugin.yaml
              dest: blueprints/website_editorial/craftercms-plugin.yaml

    - currentVersion: 3.1.0.15
      nextVersion: 3.1.0.16
      operations:
        - type: dbScriptUpgrader
          filename: upgrade-3.1.0.15-to-3.1.0.16.sql
          updateIntegrity: true

    - currentVersion: 3.1.0.16
      nextVersion: 3.1.0.17
      operations:
        - type: dbScriptUpgrader
          filename: upgrade-3.1.0.16-to-3.1.0.17.sql
          updateIntegrity: true
        - type: xsltFileUpgrader
          path: /configuration/global-menu-config.xml
          template: crafter/studio/upgrade/3.1.0.17/global-menu-config-3.xslt

    - currentVersion: 3.1.0.17
      nextVersion: 3.1.0.18
      operations:
        - type: dbScriptUpgrader
          filename: upgrade-3.1.0.17-to-3.1.0.18.sql
          updateIntegrity: true

    - currentVersion: 3.1.0.18
      nextVersion: 3.1.0.19
      operations:
        - type: dbScriptUpgrader
          filename: upgrade-3.1.0.18-to-3.1.0.19.sql
          updateIntegrity: true

    - currentVersion: 3.1.0.19
      nextVersion: 3.1.0.20
      operations:
        - type: dbScriptUpgrader
          filename: upgrade-3.1.0.19-to-3.1.0.20.sql
          updateIntegrity: true

    - currentVersion: 3.1.0.20
      nextVersion: 3.1.0.21
      operations:
        - type: dbScriptUpgrader
          filename: upgrade-3.1.0.20-to-3.1.0.21.sql
          updateIntegrity: true
        - type: renameUpgrader
          oldPath: blueprints/website_editorial
          newPath: blueprints/1000_website_editorial
          commitDetails: Rename Editorial blueprint
          overwrite: true
        - type: renameUpgrader
          oldPath: blueprints/headless_store
          newPath: blueprints/2000_headless_store
          commitDetails: Rename Headless Store blueprint
          overwrite: true
        - type: renameUpgrader
          oldPath: blueprints/video-center
          newPath: blueprints/3000_video-center
          commitDetails: Rename Video Center blueprint
          overwrite: true
        - type: renameUpgrader
          oldPath: blueprints/empty
          newPath: blueprints/4000_empty
          commitDetails: Rename Empty blueprint
          overwrite: true
        - type: renameUpgrader
          oldPath: blueprints/headless_blog
          newPath: blueprints/5000_headless_blog
          commitDetails: Rename Headless Blog blueprint
          overwrite: true
    - currentVersion: 3.1.0.21
      nextVersion: 3.1.0.22
      operations:
        - type: dbScriptUpgrader
          filename: upgrade-3.1.0.21-to-3.1.0.22.sql
          updateIntegrity: true
    - currentVersion: 3.1.0.22
      nextVersion: 3.1.0.23
      operations:
        - type: xsltFileUpgrader
          path: /configuration/global-menu-config.xml
          template: crafter/studio/upgrade/3.1.0.23/global-menu-config.xslt
          commitDetails: Add logging console & levels
        - type: xsltFileUpgrader
          path: /configuration/global-permission-mappings-config.xml
          template: crafter/studio/upgrade/3.1.0.23/global-permission-mappings-config.xslt
          commitDetails: Add logging permission
        - type: dbScriptUpgrader
          filename: upgrade-3.1.0.22-to-3.1.0.23.sql
          updateIntegrity: false
    - currentVersion: 3.1.0.23
      nextVersion: 3.1.0.24
      operations:
        - type: dbScriptUpgrader
          filename: upgrade-3.1.0.23-to-3.1.0.24.sql
          updateIntegrity: true
        - type: globalRepoUpgrader
          commitDetails: Move sample files to global repository
          files:
            - configuration/samples/sample-asset-processing-config.xml
            - configuration/samples/sample-aws.xml
            - configuration/samples/sample-box.xml
            - configuration/samples/sample-cmis-config.xml
            - configuration/samples/sample-config-list.xml
            - configuration/samples/sample-contextual-nav.xml
            - configuration/samples/sample-engine-application-context.xml
            - configuration/samples/sample-engine-site-config.xml
            - configuration/samples/sample-environment-config.xml
            - configuration/samples/sample-form-control-rte-setup.xml
            - configuration/samples/sample-form-control-rte-setup-tinymce5.xml
            - configuration/samples/sample-mime-type.xml
            - configuration/samples/sample-notification-config.xml
            - configuration/samples/sample-permission-mappings-config.xml
            - configuration/samples/sample-preview-components-config.xml
            - configuration/samples/sample-preview-panel.xml
            - configuration/samples/sample-resolver-config.xml
            - configuration/samples/sample-role-mappings-config.xml
            - configuration/samples/sample-sidebar.xml
            - configuration/samples/sample-site-config.xml
            - configuration/samples/sample-site-config-tools.xml
            - configuration/samples/sample-targeting-config.xml
            - configuration/samples/sample-urlrewrite.xml
            - configuration/samples/sample-webdav.xml

  # Pipeline to upgrade site repositories
  site:
    - currentVersion: 3.0.x
      nextVersion: 3.1.0
      operations:
        # Try to update content monitor queries with Elasticsearch datetime syntax
        - type: findAndReplaceUpgrader
          includedPaths:
            - config/studio/site-config.xml
          pattern: NOW
          replacement: now
        - type: findAndReplaceUpgrader
          includedPaths:
            - config/studio/site-config.xml
          pattern: DAYS?
          replacement: d
        - type: findAndReplaceUpgrader
          includedPaths:
            - config/studio/site-config.xml
          pattern: MONTHS?
          replacement: m
        - type: findAndReplaceUpgrader
          includedPaths:
            - config/studio/site-config.xml
          pattern: YEARS?
          replacement: y
        - type: findAndReplaceUpgrader
          includedPaths:
            - config/studio/site-config.xml
          pattern: \/(d|m|y)(\+|\-)([^\s\]]+)
          replacement: $2$3/$1
        - type: versionFileUpgrader

    - currentVersion: 3.1.0
      nextVersion: 3.1.0.1
      operations:
        - type: addFileUpgrader
          path: /config/studio/administration/samples/sample-urlrewrite.xml
          file: crafter/studio/upgrade/3.1.0.1/sample-urlrewrite.xml
          commitDetails: Add sample file for url rewrite
        - type: versionFileUpgrader

    - currentVersion: 3.1.0.1
      nextVersion: 3.1.0.2
      operations:
        - type: addFileUpgrader
          path: /config/studio/administration/samples/sample-webdav.xml
          file: crafter/studio/upgrade/3.1.0.2/sample-webdav.xml
          commitDetails: Add sample file for webdav
        - type: versionFileUpgrader

    - currentVersion: 3.1.0.2
      nextVersion: 3.1.0.3
      operations:
        - type: addSiteUuidUpgrader
        - type: versionFileUpgrader

    - currentVersion: 3.1.0.3
      nextVersion: 3.1.0.4
      operations:
        - type: boxControlUpgrader
          includedPaths: /?site/.*\.xml
          formDefinitionXpath: /form/sections/section/fields/field/type[text()='box-file-upload']
          fieldNameXpath: /form/sections/section/fields/field/type[text()='box-file-upload']/../id
          profileIdXpath: /form/sections/section/fields/field/id[text()='${id}']/../properties/property/name[text()='profile_id']/../value
          itemXpath: //${id}/item
          itemIdXpath: id
          itemNameXpath: name
          urlElementName: url
          urlTemplate: /remote-assets/box/${profile}/${id}.${extension}
          commitDetails: Add new <url> tag to fields that use the Box File Upload control
        - type: versionFileUpgrader

    - currentVersion: 3.1.0.4
      nextVersion: 3.1.0.5
      operations:
        - type: addFileUpgrader
          path: /config/studio/form-control-config/rte/rte-setup-tinymce5.xml
          file: crafter/studio/upgrade/3.1.0.5/rte-setup-tinymce5.xml
        - type: addFileUpgrader
          path: /config/studio/administration/samples/sample-form-control-rte-setup-tinymce5.xml
          file: crafter/studio/upgrade/3.1.0.5/sample-form-control-rte-setup-tinymce5.xml
        - type: versionFileUpgrader

    - currentVersion: 3.1.0.5
      nextVersion: 3.1.0.6
      operations:
        - type: addFileUpgrader
          path: /config/engine/application-context.xml
          file: crafter/studio/upgrade/3.1.0.6/application-context.xml
        - type: addFileUpgrader
          path: /config/engine/site-config.xml
          file: crafter/studio/upgrade/3.1.0.6/site-config.xml
        - type: versionFileUpgrader

    - currentVersion: 3.1.0.6
      nextVersion: 3.1.0.7
      operations:
        - type: deleteUpgrader
          commitDetails: Delete sample files
          paths:
            - /config/studio/administration/samples

  # Pipeline to upgrade blueprints
  blueprint:
    - currentVersion: 3.0.0
      nextVersion: 3.1.0
      operations:
        # This just overrides the blueprints in the repo, in the future this should be replaced with proper operations
        - type: blueprintsUpgrader

# Managed Configuration Files
configurations:

  permission-mappings-config:
    path: &permission-mappings-config '/config/studio/permission-mappings-config.xml'
    pipeline:
      - currentVersion: 1
        nextVersion: 2
        operations:
          - type: xsltFileUpgrader
            path: *permission-mappings-config
            template: crafter/studio/upgrade/3.0.x/permission-mappings-config-2.xslt
            commitDetails: Add new S3 permissions
          - type: xsltFileUpgrader
            path: *permission-mappings-config
            template: crafter/studio/upgrade/update-version.xslt

  role-mappings-config:
    path: &role-mappings-config '/config/studio/role-mappings-config.xml'
    pipeline:
      # Initial version, assumed if the file doesn't contain a version tag
      - currentVersion: 1
        nextVersion: 2
        operations:
          - type: xsltFileUpgrader
            path: *role-mappings-config
            template: crafter/studio/upgrade/3.1.0/role-mappings-config-2.xslt
            commitDetails: Update role mappings configuration
          - type: xsltFileUpgrader
            path: *role-mappings-config
            template: crafter/studio/upgrade/update-version.xslt

  config-list:
    path: &config-list '/config/studio/administration/config-list.xml'
    pipeline:
      # Initial version, assumed if the file doesn't contain a version tag
      - currentVersion: 1
        nextVersion: 2
        operations:
          - type: xsltFileUpgrader
            path: *config-list
            template: crafter/studio/upgrade/3.1.0.1/config-list-2.xslt
            commitDetails: Add url rewrite to configuration list
          - type: xsltFileUpgrader
            path: *config-list
            template: crafter/studio/upgrade/update-version.xslt
      - currentVersion: 2
        nextVersion: 3
        operations:
          - type: xsltFileUpgrader
            path: *config-list
            template: crafter/studio/upgrade/3.1.0.2/config-list-3.xslt
            commitDetails: Add webdav to configuration list
          - type: xsltFileUpgrader
            path: *config-list
            template: crafter/studio/upgrade/update-version.xslt
      - currentVersion: 3
        nextVersion: 4
        operations:
          - type: xsltFileUpgrader
            path: *config-list
            template: crafter/studio/upgrade/3.1.0.18/config-list-4.xslt
            commitDetails: Add rte-tinymce5 to configuration list
          - type: xsltFileUpgrader
            path: *config-list
            template: crafter/studio/upgrade/update-version.xslt

  site-config-tools:
    path: &site-config-tools '/config/studio/administration/site-config-tools.xml'
    pipeline:
      - currentVersion: 1
        nextVersion: 2
        operations:
          - type: xsltFileUpgrader
            path: *site-config-tools
            template: crafter/studio/upgrade/3.1.0.2/site-config-tools-2.xslt
            commitDetails: Add webdav datasources to site configuration
          - type: xsltFileUpgrader
            path: *site-config-tools
            template: crafter/studio/upgrade/update-version.xslt
      - currentVersion: 2
        nextVersion: 3
        operations:
          - type: xsltFileUpgrader
            path: *site-config-tools
            template: crafter/studio/upgrade/3.1.0.5/site-config-tools-3.xslt
          - type: xsltFileUpgrader
            path: *site-config-tools
            template: crafter/studio/upgrade/update-version.xslt
      - currentVersion: 3
        nextVersion: 4
        operations:
          - type: xsltFileUpgrader
            path: *site-config-tools
            template: crafter/studio/upgrade/3.1.0.18/site-config-tools-4.xslt
            commitDetails: Add S3 datasources, GraphiQL and remove Logging Levels from site configuration
          - type: xsltFileUpgrader
            path: *site-config-tools
            template: crafter/studio/upgrade/update-version.xslt

  environment-config:
    path: &environment-config '/config/studio/environment/environment-config.xml'
    pipeline:
      - currentVersion: 1
        nextVersion: 2
        operations:
          - type: xsltFileUpgrader
            path: *environment-config
            template: crafter/studio/upgrade/3.1.0.24/environment-config.xslt
            commitDetails: Add previewEngineServerUrl and graphqlServerUrl properties to environment configuration